name: Build and Deploy to TestFlight

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'build'
        type: choice
        options:
          - build
          - patch
          - minor

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: macos-15

    env:
      SCHEME: OpenClaw
      PROJECT: OpenClaw.xcodeproj

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install pnpm dependencies
        run: pnpm install --frozen-lockfile

      - name: Select Xcode version
        run: |
          # Swift packages require tools version 6.2 → needs Xcode 26+
          if [ -d "/Applications/Xcode_26.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.0.app/Contents/Developer
          elif [ -d "/Applications/Xcode_26.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.app/Contents/Developer
          elif [ -d "/Applications/Xcode.app" ]; then
            XCODE_VERSION=$(xcodebuild -version | head -1 | awk '{print $2}' | cut -d. -f1)
            if [ "$XCODE_VERSION" -ge 26 ]; then
              sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
            else
              echo "ERROR: Xcode 26+ required (Swift tools 6.2), found Xcode $XCODE_VERSION"
              exit 1
            fi
          else
            echo "ERROR: Xcode not found"
            exit 1
          fi
          xcodebuild -version
          xcodebuild -runFirstLaunch || true

      - name: Download iOS and watchOS platforms
        run: |
          for platform in iOS watchOS; do
            for i in 1 2 3; do
              echo "Attempt $i: Downloading $platform platform..."
              if xcodebuild -downloadPlatform $platform; then
                echo "$platform platform downloaded successfully"
                break
              fi
              [ $i -lt 3 ] && sleep 30
            done
          done

      - name: Install xcodegen and fastlane
        run: brew install xcodegen fastlane

      - name: Configure signing
        env:
          IOS_DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.OPENCLAW_BUNDLE_ID }}
        run: |
          CONFIG="apps/ios/.local-signing.xcconfig"
          cat > "$CONFIG" <<EOF
          // Auto-generated by CI — do not commit
          OPENCLAW_DEVELOPMENT_TEAM = ${IOS_DEVELOPMENT_TEAM}
          OPENCLAW_IOS_SELECTED_TEAM = ${IOS_DEVELOPMENT_TEAM}
          OPENCLAW_CODE_SIGN_STYLE = Automatic
          // Clear hardcoded profile names so automatic signing picks the right ones
          OPENCLAW_APP_PROFILE =
          OPENCLAW_SHARE_PROFILE =
          EOF
          # Override bundle ID if provided (defaults to ai.openclaw.ios from project.yml)
          if [ -n "${BUNDLE_ID}" ]; then
            echo "OPENCLAW_APP_BUNDLE_ID = ${BUNDLE_ID}" >> "$CONFIG"
            echo "OPENCLAW_SHARE_BUNDLE_ID = ${BUNDLE_ID}.share" >> "$CONFIG"
          fi
          echo "=== Signing config ==="
          cat "$CONFIG"

      - name: Generate Xcode project
        working-directory: apps/ios
        run: xcodegen generate

      - name: Install App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APPSTORE_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${API_KEY_ID}.p8

      - name: Normalize provisioning profile directories
        run: |
          USERDATA_PROFILES="$HOME/Library/Developer/Xcode/UserData/Provisioning Profiles"
          MOBILEDEVICE_PROFILES="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$USERDATA_PROFILES" "$MOBILEDEVICE_PROFILES"
          # Xcode/CI tooling can read/write either path depending on version.
          # Mirror existing profiles, then make MobileDevice point at UserData.
          rsync -a "$MOBILEDEVICE_PROFILES/" "$USERDATA_PROFILES/" || true
          if [ ! -L "$MOBILEDEVICE_PROFILES" ]; then
            rm -rf "$MOBILEDEVICE_PROFILES"
            ln -s "$USERDATA_PROFILES" "$MOBILEDEVICE_PROFILES"
          fi

      - name: Register all bundle IDs in App Store Connect
        env:
          ASC_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPSTORE_API_KEY_ISSUER_ID }}
          IOS_DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.OPENCLAW_BUNDLE_ID }}
        run: |
          APP_ID="${BUNDLE_ID:-ai.openclaw.ios}"
          export ASC_KEY_PATH="${HOME}/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          for id in "$APP_ID" "${APP_ID}.share" "${APP_ID}.watchkitapp" "${APP_ID}.watchkitapp.extension"; do
            fastlane run produce \
              app_identifier:"$id" \
              app_name:"OpenClaw" \
              language:"English" \
              app_version:"1.0" \
              sku:"openclaw-${id##*.}" \
              skip_itc:true \
              skip_devcenter:false || true
          done

      - name: Archive app
        working-directory: apps/ios
        env:
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          API_KEY_ISSUER_ID: ${{ secrets.APPSTORE_API_KEY_ISSUER_ID }}
          IOS_DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild archive \
            -project $PROJECT \
            -scheme $SCHEME \
            -configuration Release \
            -archivePath build/OpenClaw.xcarchive \
            -destination "generic/platform=iOS" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID $API_KEY_ID \
            -authenticationKeyIssuerID $API_KEY_ISSUER_ID \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=$IOS_DEVELOPMENT_TEAM \
            PROVISIONING_PROFILE= \
            PROVISIONING_PROFILE_SPECIFIER=

      - name: Export and upload to TestFlight
        working-directory: apps/ios
        env:
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          API_KEY_ISSUER_ID: ${{ secrets.APPSTORE_API_KEY_ISSUER_ID }}
          IOS_DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          /usr/libexec/PlistBuddy -c "Clear dict" ExportOptions.plist 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :method string 'app-store-connect'" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :destination string 'upload'" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :signingStyle string 'automatic'" ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :teamID string '${IOS_DEVELOPMENT_TEAM}'" ExportOptions.plist

          xcodebuild -exportArchive \
            -archivePath build/OpenClaw.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/export \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID $API_KEY_ID \
            -authenticationKeyIssuerID $API_KEY_ISSUER_ID

      - name: Clean up API key
        if: always()
        env:
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        run: rm -f ~/private_keys/AuthKey_${API_KEY_ID}.p8 || true

      - name: Summary
        run: |
          echo "## TestFlight Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The build has been uploaded to TestFlight and will be available after Apple processes it (5-30 minutes)." >> $GITHUB_STEP_SUMMARY
