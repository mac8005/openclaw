name: Build and Deploy to TestFlight

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'build'
        type: choice
        options:
          - build
          - patch
          - minor

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: macos-15

    env:
      SCHEME: OpenClaw
      PROJECT: OpenClaw.xcodeproj

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install pnpm dependencies
        run: pnpm install --frozen-lockfile

      - name: Select Xcode version
        run: |
          # Swift packages require tools version 6.2 → needs Xcode 26+
          if [ -d "/Applications/Xcode_26.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.0.app/Contents/Developer
          elif [ -d "/Applications/Xcode_26.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.app/Contents/Developer
          elif [ -d "/Applications/Xcode.app" ]; then
            XCODE_VERSION=$(xcodebuild -version | head -1 | awk '{print $2}' | cut -d. -f1)
            if [ "$XCODE_VERSION" -ge 26 ]; then
              sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
            else
              echo "ERROR: Xcode 26+ required (Swift tools 6.2), found Xcode $XCODE_VERSION"
              exit 1
            fi
          else
            echo "ERROR: Xcode not found"
            exit 1
          fi
          xcodebuild -version
          xcodebuild -runFirstLaunch || true

      - name: Install xcodegen and fastlane
        run: brew install xcodegen fastlane

      - name: Configure signing
        env:
          IOS_DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.OPENCLAW_BUNDLE_ID }}
        run: |
          CONFIG="apps/ios/.local-signing.xcconfig"
          cat > "$CONFIG" <<EOF
          // Auto-generated by CI — do not commit
          OPENCLAW_DEVELOPMENT_TEAM = ${IOS_DEVELOPMENT_TEAM}
          OPENCLAW_IOS_SELECTED_TEAM = ${IOS_DEVELOPMENT_TEAM}
          OPENCLAW_CODE_SIGN_STYLE = Automatic
          EOF
          # Override bundle ID if provided (defaults to ai.openclaw.ios from project.yml)
          if [ -n "${BUNDLE_ID}" ]; then
            echo "OPENCLAW_APP_BUNDLE_ID = ${BUNDLE_ID}" >> "$CONFIG"
            echo "OPENCLAW_SHARE_BUNDLE_ID = ${BUNDLE_ID}.share" >> "$CONFIG"
          fi
          echo "=== Signing config ==="
          cat "$CONFIG"

      - name: Generate Xcode project
        working-directory: apps/ios
        run: xcodegen generate

      - name: Install App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APPSTORE_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${API_KEY_ID}.p8

      - name: Register app in App Store Connect (if needed)
        working-directory: apps/ios
        env:
          ASC_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPSTORE_API_KEY_ISSUER_ID }}
          IOS_DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.OPENCLAW_BUNDLE_ID }}
        run: |
          export ASC_KEY_PATH="${HOME}/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          APP_ID="${BUNDLE_ID:-ai.openclaw.ios}"
          # produce registers the bundle ID in the Developer Portal and creates
          # the App Store Connect record if they don't already exist.
          fastlane run produce \
            app_identifier:"$APP_ID" \
            app_name:"OpenClaw" \
            language:"English" \
            app_version:"1.0" \
            sku:"openclaw-ios" \
            skip_itc:false \
            skip_devcenter:false || true  # non-fatal if app already exists

      - name: Build and upload to TestFlight
        working-directory: apps/ios
        env:
          ASC_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPSTORE_API_KEY_ISSUER_ID }}
          IOS_DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          export ASC_KEY_PATH="${HOME}/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          fastlane beta

      - name: Clean up API key
        if: always()
        env:
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        run: rm -f ~/private_keys/AuthKey_${API_KEY_ID}.p8 || true

      - name: Summary
        run: |
          echo "## TestFlight Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The build has been uploaded to TestFlight and will be available after Apple processes it (5-30 minutes)." >> $GITHUB_STEP_SUMMARY
